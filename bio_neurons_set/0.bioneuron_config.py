# =============================================================
# bioneuron_config_v1.py — Bio-Neuron Configuration
# =============================================================
# 목적:
#   - DTG(위상·에너지), Mito(ATP), HH 소마, Myelinated Axon(도약전도),
#     Ca²⁺ 소포, 대사 피드백, 위상-시냅스 공명에 대한
#     파라미터 "하나의 진실(SSOT)" 딕셔너리.
#   - 공개 저장소 용: 단위/의미/수식 명시, 하드코딩 금지.
#
# 특징:
#   - CONFIG ONLY (수식 포함, 실행 로직 없음)
#   - 모든 파라미터에 단위와 의미 명시
#   - 수치 안정성을 위한 CFL 조건 검증 기능 포함
#
# 검증 포인트:
#   - CFL 조건: dt_elec <= 0.9 * dx^2 / (2*max(D_node, D_internode))
#   - 아래 값들로 v~50~80 m/s 도약전도 관측 (시뮬레이터 의존)
#   - CFL 위반 시 수치 불안정성 발생 가능
#
# 사용법:
#   - get_config(): 안전한 복사본 반환 (딕셔너리 변경 방지)
#   - cfl_dt_ax(): CFL 상한 계산
#   - print_cfl_report(): CFL 조건 검증 리포트 출력
# =============================================================

from copy import deepcopy
from math import pi

CONFIG = {
    # -----------------------------------------------------------------
    # [DTG Layer — Energy–Phase Dynamics]
    # -----------------------------------------------------------------
    # DTG (Dynamic Topographic Generator): 에너지-위상 동기화 시스템
    # 
    # 수식:
    #   dE/dt = g_sync · (ATP - E) - γ · (E - E0)
    #   dφ/dt = ω0 + α · (E - E0)
    #
    # 의미:
    #   - E: 메타 에너지 스칼라 (ATP 수준과 동기화)
    #   - φ: 내부 위상 [rad] (신경 발화 패턴 조절)
    #   - ATP 수준이 높을수록 E가 증가하고, 위상 속도가 빨라짐
    #
    # 단위:
    #   - t: [ms] (밀리초)
    #   - φ: [rad] (라디안)
    #   - E: [arb] (임의 단위)
    # -----------------------------------------------------------------
    "DTG": {
        "E0": 100.0,          # 기준 에너지 [arb] (균형점)
        "omega0": 1.0,        # 기본 위상속도 [rad/ms] (기본 발화 주기)
        "alpha": 0.03,        # 에너지-위상 결합 계수 (E가 위상 속도에 미치는 영향)
        "gamma": 0.10,        # 에너지 복원 계수 [1/ms] (E가 E0로 복귀하는 속도)
        "sync_gain": 0.20,    # ATP–E 동조 이득 [1/ms] (ATP와 E의 동기화 속도)
    },

    # -----------------------------------------------------------------
    # [Mitochondria Layer — Energy Metabolism]
    # -----------------------------------------------------------------
    # 미토콘드리아: ATP 생산 및 대사 부산물(Heat, CO₂) 관리
    #
    # 수식:
    #   dE_buf/dt = (P_in - P_loss) - k_transfer·(E_buf - ATP)
    #   dATP/dt   = k_transfer·(E_buf - ATP) - J_use
    #   Heat↑ = (1-η)·k_transfer·(E_buf - ATP)_+
    #   CO₂ ↑ = c_CO₂ · k_transfer·(E_buf - ATP)_+
    #
    # 의미:
    #   - E_buf: 에너지 버퍼 (NADH, FADH₂, 전자전달계 에너지 풀)
    #   - ATP: 아데노신 삼인산 (실제 사용 가능한 에너지)
    #   - η: 전환 효율 (0~1, 효율이 낮을수록 Heat 증가)
    #   - J_use: ATP 소비율 (Na/K 펌프, Ca 펌프 등)
    #
    # 단위:
    #   - ATP, E_buf: [arb] (임의 단위)
    #   - P_in, P_loss, J_use: [arb/ms]
    #   - Heat, CO₂: [arb] (누적량)
    # -----------------------------------------------------------------
    "MITO": {
        "ATP0": 100.0,          # 초기 ATP 농도 [arb]
        "Ebuf0": 80.0,           # 초기 에너지 버퍼 [arb]
        "Pin": 10.0,             # 에너지 유입량 [arb/ms] (Glucose + O₂ 기반)
        "Ploss": 1.5,            # 에너지 손실량 [arb/ms] (기본 대사 유지비)
        "recover_k": 8.0,        # ATP 회복 계수 [arb/ms] (저ATP일 때 회복 속도)
        "recover_thresh": 60.0,  # 회복 시작 임계값 [arb] (이 값 이하에서 회복)
        "delta_transfer": 5.0,   # ATP 전환 최소 차이 [arb] (E_buf-ATP > 이 값일 때만 전환)
        "ATP_clip": (1.0, 110.0),  # ATP 클램프 범위 [arb] (최소, 최대)
        "Ebuf_clip": (15.0, 100.0), # E_buf 클램프 범위 [arb] (최소, 최대)
        "k_transfer": 0.4,       # E_buf→ATP 전환 계수 [1/ms]
        "eta": 0.60,             # 전환 효율 (0~1, 0.6 = 60% 효율, 40%는 Heat로 손실)
        "c_CO2": 0.80,           # CO₂ 생성 비율 (ATP당 CO₂ 양)
        "Heat0": 0.0,            # 초기 누적 발열 [arb]
        "CO2_0": 0.0,            # 초기 누적 CO₂ [arb]
    },

    # -----------------------------------------------------------------
    # [Hodgkin–Huxley Soma — Membrane]
    # -----------------------------------------------------------------
    # Hodgkin-Huxley 모델: 막전위 동역학 및 액션 전위 생성
    #
    # 수식:
    #   C_m dV/dt = g_Na m³h (E_Na - V) + g_K n⁴ (E_K - V) + g_L (E_L - V)
    #                + I_ext - I_pump(ATP)
    #   dm/dt = α_m(V)(1-m) - β_m(V)m  (h, n 유사식)
    #   I_pump(선택) = g_pump · (1 - exp[-ATP/ATP0_ref]) · (V - E_pump)
    #
    # 의미:
    #   - V: 막전위 [mV]
    #   - m, h, n: 게이트 변수 (0~1, Na⁺ 활성화/불활성화, K⁺ 활성화)
    #   - g_Na, g_K, g_L: 전도도 [mS/cm²]
    #   - E_Na, E_K, E_L: 역평형 전위 [mV]
    #   - I_pump: Na/K 펌프 전류 (ATP 의존적, 선택적)
    #
    # 단위:
    #   - V: [mV] (밀리볼트)
    #   - t: [ms] (밀리초)
    #   - g: [mS/cm²] (밀리지멘스/cm²)
    #   - I: [μA/cm²] (마이크로암페어/cm²)
    # -----------------------------------------------------------------
    "HH": {
        "V0": -70.0,           # 초기 막전위 [mV] (휴지 전위)
        "gNa": 120.0,          # Na⁺ 전도도 [mS/cm²]
        "gK": 36.0,            # K⁺ 전도도 [mS/cm²]
        "gL": 0.3,             # 누설 전도도 [mS/cm²]
        "ENa": 50.0,           # Na⁺ 역평형 전위 [mV]
        "EK": -77.0,           # K⁺ 역평형 전위 [mV]
        "EL": -54.4,           # 누설 역평형 전위 [mV]
        "spike_thresh": 0.0,   # 스파이크 임계값 [mV] (>0mV일 때 spike로 카운트)
        # 선택적 펌프 파라미터 (모델에 연결 시 사용)
        "use_pump": False,     # Na/K 펌프 사용 여부
        "g_pump": 0.0,         # 펌프 전도도 [mS/cm²] (use_pump=True일 때 사용)
        "E_pump": -70.0,       # 펌프 역평형 전위 [mV]
        "ATP0_ref": 100.0,     # ATP 참조 값 [arb] (펌프 효율 계산용)
    },

    # -----------------------------------------------------------------
    # [Myelinated Axon — Saltatory Conduction]
    # -----------------------------------------------------------------
    # 수초화 축삭: 도약전도 (Saltatory Conduction) 모델
    #
    # 수식:
    #   ∂V/∂t = D(x)∂²V/∂x² - g_L(x)(V-E_L)/C_m(x)
    #            + [I_ext + I_Na_node] / C_m(x)
    #
    # Node Na gate (간이 모델):
    #   dm/dt = (m_inf(V)-m)/τ_m
    #   dh/dt = (h_inf(V)-h)/τ_h
    #   I_Na_node = gNa_node m³h (E_Na_node - V)
    #   m_inf = σ((V-Vh_m)/k_m),  h_inf = σ((V-Vh_h)/k_h)
    #   σ(x) = 1/(1+e^-x)  (sigmoid 함수)
    #
    # 의미:
    #   - Node (Ranvier): Na⁺ 채널 활성, 빠른 전도
    #   - Internode (Myelin): 절연, 느린 전도, 낮은 누설
    #   - 도약전도: 신호가 노드에서 노드로 점프하여 빠르게 전달
    #   - 속도 추정: 첫 임계통과 시각 간격의 평균으로 v[m/s] 계산
    #
    # 단위:
    #   - x: [cm] (센티미터)
    #   - t: [ms] (밀리초)
    #   - V: [mV] (밀리볼트)
    #   - D: [cm²/ms] (확산 계수)
    #   - Cm: [μF/cm²] (막용량)
    #   - gL: [mS/cm²] (누설 전도도)
    # -----------------------------------------------------------------
    "AXON": {
        # === 격자/구조 ===
        "N": 121,                # 그리드 노드 수 (축삭 길이 = N*dx)
        "node_period": 5,        # 노드 간격 (0, 5, 10, ... 가 노드)
        "dx": 1.0e-3,            # 공간 간격 [cm] ★CFL 안정 위해 1e-3 권장
        "Vrest": -70.0,          # 휴지 전위 [mV]
        "EL": -54.4,             # 누설 역평형 전위 [mV]
        "tau": 1.2,              # 감쇠 상수 [ms] (필요시 사용)

        # === 확산/막용량/누설 (node vs internode) ===
        # Node (Ranvier): 빠른 전도, 높은 확산
        "D_node": 1.5e-3,        # 노드 확산 계수 [cm²/ms] ★노드 전도 강화
        "Cm_node": 1.0,          # 노드 막용량 [μF/cm²]
        "gL_node": 0.25,         # 노드 누설 전도도 [mS/cm²]
        
        # Internode (Myelin): 절연, 낮은 확산
        "D_internode": 1.5e-5,   # 인터노드 확산 계수 [cm²/ms] ★말이집 절연(낮게)
        "Cm_myelin": 0.005,      # 말이집 막용량 [μF/cm²] (매우 낮음)
        "gL_myelin": 1.0e-4,     # 말이집 누설 전도도 [mS/cm²] ★감쇠 최소화

        # === 노드 Na 게이트 ===
        # 노드에서만 Na⁺ 채널이 활성화되어 액션 전위 재생성
        "node_gNa": 1200.0,      # 노드 Na⁺ 전도도 [mS/cm²] ★다음 노드 재생성 보장
        "node_ENa": 50.0,        # 노드 Na⁺ 역평형 전위 [mV]
        "node_m_tau": 0.03,      # m 게이트 시간 상수 [ms] (빠른 활성화)
        "node_h_tau": 0.40,      # h 게이트 시간 상수 [ms] (적당한 불활성화)
        "node_m_inf_k": 6.0,     # m_inf slope 파라미터
        "node_m_inf_Vh": -37.0,  # m_inf half-activation 전위 [mV]
        "node_h_inf_k": -6.0,    # h_inf slope 파라미터 (내림형, 음수)
        "node_h_inf_Vh": -58.0,  # h_inf half-activation 전위 [mV]

        # === 임계/안정성 ===
        "thresh": -50.0,         # 임계 통과 기준 [mV] (이 값 이상이면 스파이크)
        "cfl_safety": 0.9,       # CFL 안전 계수 (dt_cfl = cfl * dx² / (2*Dmax))

        # === 구동/결합 ===
        "coupling": 0.0,         # 소마-축삭 직접결합 계수 (0 = 초기 전도 확인 모드)
        "stim_gain": 15.0,       # 소마→0번노드 주입 이득 (사용 시)
        
        # === 선택적 인플레이션/감쇠 ===
        # 시간에 따른 확산 계수 조정 및 추가 감쇠 항
        "c0": 1.0,               # 초기 확산 스케일
        "Lambda": 0.0,           # 시간 감쇠 계수 [1/ms] (0 = 비활성)
        "gamma_decay": 0.0,      # 추가 감쇠 계수 [1/ms] (0 = 비활성)
    },

    # -----------------------------------------------------------------
    # [Ca²⁺ Vesicle — Synaptic Release]
    # -----------------------------------------------------------------
    # Ca²⁺ 소포: 시냅스 전달물질 방출을 위한 Ca²⁺ 농도 모델링
    #
    # 수식:
    #   d[Ca]/dt = Σ_k A·α(t - t_k) - k_c·ATP·([Ca] - [Ca]_0)
    #   α(t) = (e^{-t/τ_d} - e^{-t/τ_r})_+   (스파이크 트리거 커널)
    #   S = ([Ca]-[Ca]_0)/([Ca]_max-[Ca]_0) ∈ ℝ  (포화도)
    #
    # 의미:
    #   - 스파이크 발생 시 Ca²⁺ 유입 (α 커널)
    #   - ATP 의존적 Ca²⁺ 펌프로 Ca²⁺ 제거
    #   - S: 포화도 (0~1, under/normal/alert 상태 판단)
    #
    # 단위:
    #   - [Ca]: [M] (몰, 또는 [mM]로 정규화)
    #   - t: [ms] (밀리초)
    #   - tau_r, tau_d: [s] (초, 내부적으로 ms로 변환)
    # -----------------------------------------------------------------
    "CA": {
        "C0": 1e-4,                # 기준 Ca²⁺ 농도 [M] (휴지 상태)
        "Cmax": 2e-3,              # 최대 Ca²⁺ 농도 스케일 [M] (포화 기준)
        "A": 1.2e-3,               # α 커널 스케일 (스파이크당 Ca²⁺ 유입량)
        "tau_r": 0.01,             # α 커널 상승 시간 [s] (빠른 유입)
        "tau_d": 0.20,             # α 커널 감쇠 시간 [s] (느린 감쇠)
        "k_c": 0.20,               # Ca²⁺ 펌프 계수 [1/ms] (ATP 의존적)
        "max_spike_memory_ms": 2000.0,  # 스파이크 메모리 최대 시간 [ms]
        "dt_ms": 1.0,              # Ca²⁺ 업데이트 시간 스텝 [ms]
    },

    # -----------------------------------------------------------------
    # [Integrator / Run]
    # -----------------------------------------------------------------
    # 시뮬레이터 상위 시간해상도와 출력 주기 설정
    #
    # CFL 조건:
    #   dt_elec <= 0.9 * dx² / (2 * max(D_node, D_internode))
    #   위 조건을 만족해야 수치 안정성 보장
    #
    # 시간 스케일:
    #   - dt_elec: 전기적 시간 스텝 (HH, Axon 등 빠른 동역학)
    #   - dt_bio: 생리학적 시간 스텝 (Mito, DTG 등 느린 동역학)
    #   - dt_bio ≫ dt_elec (일반적으로 100배 이상)
    # -----------------------------------------------------------------
    "RUN": {
        "T_ms": 300,              # 총 시뮬레이션 시간 [ms]
        "dt_bio": 1.0,            # 생리학적 시간 스텝 [ms] (Mito, DTG 등)
        "dt_elec": 0.01,          # 전기적 시간 스텝 [ms] ★CFL 만족: ≪ 0.3ms (본 설정)
        "print_every_ms": 2,      # 출력 주기 [ms] (상태 출력 간격)
        "color": True,            # 컬러 출력 사용 여부 (터미널 출력)
    },

    # -----------------------------------------------------------------
    # [Alpha Pulse] — 스파이크 시 α-자극(선택)
    # -----------------------------------------------------------------
    # 스파이크 발생 시 추가 전류 펄스 주입
    #
    # 수식:
    #   I_alpha(t) = I0 · (e^{-t/τ_d} - e^{-t/τ_r})_+
    #
    # 의미:
    #   - 스파이크 순간에 α 펄스로 축삭 자극 강화
    #   - 양의 값만 사용 (negative clipped)
    #   - rise 후 decay (이중 지수 형태)
    #
    # 단위:
    #   - I0: [μA/cm²] (펄스 최대 진폭)
    #   - tau_r, tau_d: [ms] (상승/감쇠 시간 상수)
    # -----------------------------------------------------------------
    "ALPHA": {
        "I0": 50.0,        # 펄스 최대 진폭 [μA/cm²]
        "tau_r": 0.5,      # 상승 시간 상수 [ms] (빠른 상승)
        "tau_d": 3.0,      # 감쇠 시간 상수 [ms] (느린 감쇠)
    },

    # -----------------------------------------------------------------
    # [Energy Ledger] — 에너지/비용 회계(선택)
    # -----------------------------------------------------------------
    # 에너지 생산/소비 추적 및 회계
    #
    # 파라미터:
    #   - xi_prod: 외생적 생산률 [arb/ms] (외부에서 공급되는 에너지)
    #   - chi_spike: 스파이크 비용 [arb] (스파이크당 소비되는 에너지)
    #   - zeta_leak: 누설 비용 계수 [arb/ms] (전위 편차에 따른 누설 비용)
    #
    # 사용법:
    #   - 모든 값이 0.0이면 비활성 (에너지 회계 없음)
    #   - 양수 값으로 설정 시 에너지 생산/소비 추적 활성화
    # -----------------------------------------------------------------
    "LEDGER": {
        "xi_prod":   0.0,  # 외생적 생산률 [arb/ms] (외부 에너지 공급)
        "chi_spike": 0.0,  # 스파이크 비용 [arb] (스파이크당 에너지 소비)
        "zeta_leak": 0.0,  # 누설 비용 계수 [arb/ms] (전위 편차 누설 에너지)
    },

    # -----------------------------------------------------------------
    # [Metabolic Feedback] — Heat/CO₂/Ca 기반 대사 피드백(선택)
    # -----------------------------------------------------------------
    # 대사 부산물(Heat, CO₂, Ca²⁺)에 따른 동적 피드백 조정
    #
    # 수식:
    #   η(t+) = η0 - β_heat·Heat    (효율 감소: Heat 증가 시)
    #   P_loss(t+) = P_loss0·(1 + β_CO₂·CO₂)  (손실 증가: CO₂ 증가 시)
    #   recover_k(alert) = recover_k0 · (1 + λ_ca)  (Ca²⁺ 높을 때 회복 강화)
    #   recover_k(under) = recover_k0 · (1 - λ_under)  (Ca²⁺ 낮을 때 회복 약화)
    #
    # 의미:
    #   - Heat 증가 → 효율 감소 → 더 많은 Heat 생성 (양성 피드백)
    #   - CO₂ 증가 → 손실 증가 → ATP 생산 감소
    #   - Ca²⁺ 높음 → 회복 강화 (긴급 상황 대응)
    #   - Ca²⁺ 낮음 → 회복 약화 (정상 상태 유지)
    # -----------------------------------------------------------------
    "FEEDBACK": {
        "beta_heat": 0.0015,    # Heat 피드백 계수 [1/arb] (Heat 1단위당 효율 감소)
        "beta_co2": 0.0010,     # CO₂ 피드백 계수 [1/arb] (CO₂ 1단위당 손실 증가)
        "lambda_ca": 0.3,        # Ca²⁺ alert 상태 회복 강화 계수 (0.3 = 30% 증가)
        "lambda_under": 0.1,    # Ca²⁺ under 상태 회복 약화 계수 (0.1 = 10% 감소)
    },

    # -----------------------------------------------------------------
    # [Synaptic Resonance] — 위상–Ca 공명(선택)
    # -----------------------------------------------------------------
    # 시냅스 위상과 DTG 위상 간의 공명 모델링
    #
    # 수식:
    #   θ̇ = ω + K·sin(φ - θ)·(1 + λ·S)
    #
    # 의미:
    #   - θ: 시냅스 위상 [rad]
    #   - φ: DTG 위상 [rad]
    #   - S: Ca²⁺ 포화도 (0~1)
    #   - K: 위상 결합 강도 (DTG와 시냅스 위상 동기화)
    #   - λ: Ca²⁺ 증폭 계수 (Ca²⁺ 높을수록 결합 강화)
    #
    # 단위:
    #   - ω, θ̇: [rad/ms] (위상 속도)
    #   - K, λ: [무차원]
    # -----------------------------------------------------------------
    "RESONANCE": {
        "omega": 1.0,      # 기본 위상 속도 [rad/ms] (DTG와 동일하게 설정)
        "K": 0.05,         # 위상 결합 강도 (DTG–시냅스 위상 동기화)
        "lambda_ca": 1.0,  # Ca²⁺ 증폭 계수 (Ca²⁺ 높을수록 결합 강화)
    },
}

# =============================================================
# Helper Functions: 안전 복사 & CFL 체크
# =============================================================

def get_config():
    """
    외부에서 안전하게 CONFIG를 가져가도록 deepcopy 반환.
    
    Returns
    -------
    dict
        CONFIG 딕셔너리의 깊은 복사본 (원본 변경 방지)
        
    사용법:
        cfg = get_config()
        cfg["AXON"]["N"] = 200  # 원본은 변경되지 않음
    """
    return deepcopy(CONFIG)

def cfl_dt_ax(config=None):
    """
    CFL 상한(dt_ax) 계산: Courant-Friedrichs-Lewy 조건
    
    CFL 조건은 수치 안정성을 보장하기 위한 필수 조건입니다.
    dt > dt_cfl이면 수치 불안정성이 발생할 수 있습니다.
    
    Parameters
    ----------
    config : dict, optional
        설정 딕셔너리. 기본값: None (전역 CONFIG 사용)
        
    Returns
    -------
    float
        CFL 상한 시간 스텝 [ms]
        
    수식:
        dt_cfl = cfl_safety * dx² / (2 * Dmax)
        
    여기서:
        - cfl_safety: 안전 계수 (일반적으로 0.9)
        - dx: 공간 간격 [cm]
        - Dmax: 최대 확산 계수 [cm²/ms]
    """
    cfg = config or CONFIG
    ax = cfg["AXON"]
    dx = ax["dx"]
    Dmax = max(ax["D_node"], ax["D_internode"])
    return ax["cfl_safety"] * (dx**2) / (2.0 * Dmax)

def print_cfl_report(config=None):
    """
    CFL 리포트 간단 출력 (개발/디버그용)
    
    Parameters
    ----------
    config : dict, optional
        설정 딕셔너리. 기본값: None (전역 CONFIG 사용)
        
    출력:
        - dt_elec: 실제 사용 중인 전기적 시간 스텝 [ms]
        - dt_ax_cfl: CFL 상한 시간 스텝 [ms]
        - 상태: OK (조건 만족) 또는 VIOLATION (조건 위반)
    """
    cfg = config or CONFIG
    dt_cfl = cfl_dt_ax(cfg)
    dt_elec = cfg["RUN"]["dt_elec"]
    ok = dt_elec <= dt_cfl
    status = "OK" if ok else "VIOLATION"
    print(f"[CFL] dt_elec={dt_elec:.5f} ms, dt_ax_cfl={dt_cfl:.5f} ms → {status}")
    if not ok:
        print(f"      ⚠️ Warning: CFL 조건 위반! dt_elec를 {dt_cfl:.5f} ms 이하로 설정하세요.")

# =============================================================
# 🔬 단독 테스트 (Standalone Test)
# =============================================================
if __name__ == "__main__":
    # 모듈 단독 실행 시 CFL 리포트만 출력 (실행 로직 없음)
    print("=" * 60)
    print("Bio-Neuron Config v1 — CFL Check")
    print("=" * 60)
    print_cfl_report()
    print("=" * 60)
    print("Config module loaded successfully ✅")
