# 📋 V3 계약 원칙 (V3 Contract Principles)

V3는 **엄격한 계약 원칙**을 준수하여 네트워크 연결 시 안정성과 일관성을 보장합니다.

---

## 🎯 핵심 계약 원칙

### **1. 단일 방향화 (Unidirectional Flow)**

**원칙**: 신호는 **Soma → Axon** 방향으로만 전달됩니다.

**구현**:
- ❌ `I_back = 0.1 * (axon.V[0] - soma.V)` (역방향 참조 금지)
- ✅ Soma에서 Axon으로만 신호 전달

**효과**:
- 순환 참조 방지
- 네트워크 연결 시 안정성 보장
- 모듈 간 독립성 확보

---

### **2. 값 복사 (Value Copying)**

**원칙**: 모듈 간 데이터 전달은 **값 복사**로 이루어집니다.

**구현**:
- ❌ `ionflow.V[:] = soma.V` (참조 공유 금지)
- ✅ `ionflow.set_V(soma.V)` (값 복사)

**효과**:
- 부작용(side effect) 방지
- 모듈 간 독립성 보장
- 디버깅 용이성 향상

---

### **3. 정규화 범위**

**원칙**: 모든 물리량은 **정규화된 범위**로 통일됩니다.

#### **ATP: [0, 100]**
- 초기화: `self.ATP = float(np.clip(cfg.get("ATP0", 100.0), 0.0, 100.0))`
- 업데이트 후: `self.ATP = float(np.clip(self.ATP, 0.0, 100.0))`
- 효과: 모든 모듈에서 동일한 ATP 범위 사용

#### **S (Ca 정규화): [0, 1]**
- Ca²⁺ 농도를 정규화하여 `[0, 1]` 범위로 변환
- 효과: 시냅스 방출 확률 계산 시 일관성 보장

#### **시간 단위: [ms]**
- 모든 시간은 **밀리초 [ms]** 단위
- 효과: 모듈 간 시간 단위 통일

---

### **4. 이벤트 기반 전달**

**원칙**: 스파이크 이벤트는 **객체**로 전달되며, **값 복사**로 전달됩니다.

**구현**:
```python
@dataclass
class SpikeEvent:
    t: float              # 발생 시각 [ms]
    strength: float       # 스파이크 강도 [mV]
    metabolic_cost: float # 대사 비용 [ATP]
    plasticity_signal: float  # 가소성 신호 (PTP R)
    source_id: str       # 발생 뉴런 ID
```

**효과**:
- 네트워크 연결 시 이벤트 라우팅 용이
- 이벤트 메타데이터 보존
- 추적 가능성 향상

---

## 🔍 계약 검증 체크리스트

V3 계약 원칙을 준수하는지 확인하려면:

### **단일 방향화 확인**
- [ ] `I_back` 같은 역방향 참조가 없는지 확인
- [ ] Soma → Axon 방향으로만 신호 전달되는지 확인

### **값 복사 확인**
- [ ] `ionflow.set_V()` 메서드 사용 여부 확인
- [ ] 참조 공유(`[:]`) 대신 값 복사 사용 여부 확인

### **ATP 정규화 확인**
- [ ] ATP 초기화 시 `[0, 100]` 범위 클램핑 확인
- [ ] ATP 업데이트 후 `[0, 100]` 범위 클램핑 확인

### **S 정규화 확인**
- [ ] S (Ca 정규화)가 `[0, 1]` 범위인지 확인

### **시간 단위 확인**
- [ ] 모든 시간이 `[ms]` 단위인지 확인

---

## 📊 계약 객체

V3는 다음 계약 객체를 제공합니다:

### **SpikeEvent** (`contracts/spike_event.py`)
스파이크 이벤트를 나타내는 계약 객체입니다.

### **NeuronState** (`contracts/neuron_state.py`)
뉴런의 전체 상태를 나타내는 계약 객체입니다.

### **EnergyState** (`contracts/energy_state.py`)
에너지 상태를 나타내는 계약 객체입니다.

---

## 🚀 네트워크 연결 시 이점

V3 계약 원칙을 준수하면:

1. **안정성**: 순환 참조 방지, 부작용 방지
2. **일관성**: 정규화된 범위로 모듈 간 호환성 보장
3. **확장성**: 새로운 모듈 추가 시 계약만 준수하면 통합 가능
4. **디버깅**: 값 복사로 인한 추적 가능성 향상

---

**Version**: 3.0.0  
**Last Updated**: 2026-01-04

