# =============================================================
# 00.bioneuron_config.py — Bio-Neuron Configuration (V3)
# =============================================================
# 목적:
#   - DTG(위상·에너지), Mito(ATP), HH 소마, Myelinated Axon(도약전도),
#     Ca²⁺ 소포, 대사 피드백, 위상-시냅스 공명에 대한
#     파라미터 "하나의 진실(SSOT)" 딕셔너리.
#   - 공개 저장소 용: 단위/의미/수식 명시, 하드코딩 금지.
#
# V3 계약 고정:
#   - 시간 단위: [ms] (밀리초) - 모든 시간 관련 파라미터는 ms 단위
#   - Ca: [μM] (마이크로몰)
#   - S: [0,1] (정규화된 Ca 농도)
#   - ATP: [0,100] (정규화, 0~100 범위로 통일)
#   - 모든 함수의 입력/출력/side-effect 명시
#
# 특징:
#   - CONFIG ONLY (수식 포함, 실행 로직 없음)
#   - 모든 파라미터에 단위와 의미 명시
#   - 수치 안정성을 위한 CFL 조건 검증 기능 포함
#
# 검증 포인트:
#   - CFL 조건: dt_elec <= 0.9 * dx^2 / (2*max(D_node, D_internode))
#   - 아래 값들로 v~50~80 m/s 도약전도 관측 (시뮬레이터 의존)
#   - CFL 위반 시 수치 불안정성 발생 가능
#
# 사용법:
#   - get_config(): 안전한 복사본 반환 (딕셔너리 변경 방지)
#   - cfl_dt_ax(): CFL 상한 계산
#   - print_cfl_report(): CFL 조건 검증 리포트 출력
# =============================================================

from copy import deepcopy
from math import pi

# =============================================================
# V3 계약 명시
# =============================================================
# 시간 단위: [ms] (밀리초) - 모든 시간 관련 파라미터는 ms 단위
# Ca: [μM] (마이크로몰)
# S: [0,1] (정규화된 Ca 농도)
# ATP: [0,100] (정규화, 0~100 범위로 통일) ⭐ V3 변경
# =============================================================

CONFIG = {
    # -----------------------------------------------------------------
    # [DTG Layer — Energy–Phase Dynamics]
    # -----------------------------------------------------------------
    # DTG (Dynamic Topographic Generator): 에너지-위상 동기화 시스템
    # 
    # 수식:
    #   dE/dt = g_sync · (ATP - E) - γ · (E - E0)
    #   dφ/dt = ω0 + α · (E - E0)
    #
    # 의미:
    #   - E: 메타 에너지 스칼라 (ATP 수준과 동기화)
    #   - φ: 내부 위상 [rad] (신경 발화 패턴 조절)
    #   - ATP 수준이 높을수록 E가 증가하고, 위상 속도가 빨라짐
    #
    # 단위:
    #   - t: [ms] (밀리초) ⭐ V3 계약 고정
    #   - φ: [rad] (라디안)
    #   - E: [arb] (임의 단위)
    #   - ATP: [0,100] (정규화, 0~100 범위) ⭐ V3 계약 고정
    # -----------------------------------------------------------------
    "DTG": {
        "E0": 100.0,          # 기준 에너지 [arb] (균형점)
        "omega0": 1.0,        # 기본 위상속도 [rad/ms] ⭐ V3: ms 단위 명시
        "alpha": 0.03,        # 에너지-위상 결합 계수 (E가 위상 속도에 미치는 영향)
        "gamma": 0.10,        # 에너지 복원 계수 [1/ms] ⭐ V3: ms 단위 명시
        "sync_gain": 0.20,    # ATP–E 동조 이득 [1/ms] ⭐ V3: ms 단위 명시
    },

    # -----------------------------------------------------------------
    # [Mitochondria Layer — Energy Metabolism]
    # -----------------------------------------------------------------
    # 미토콘드리아: ATP 생산 및 대사 부산물(Heat, CO₂) 관리
    #
    # 수식:
    #   dE_buf/dt = (P_in - P_loss) - k_transfer·(E_buf - ATP)
    #   dATP/dt   = k_transfer·(E_buf - ATP) - J_use
    #   Heat ↑ = (1 - η)·J_transfer
    #   CO₂ ↑ = c_CO2·J_transfer
    #
    # 의미:
    #   - E_buf: 에너지 버퍼 (NADH, FADH₂, 전자전달계 에너지 풀)
    #   - ATP: 아데노신 삼인산 (실제 사용 가능한 에너지)
    #   - η: 전환 효율 (0~1, 효율이 낮을수록 Heat 증가)
    #   - J_use: ATP 소비율 (Na/K 펌프, Ca 펌프 등)
    #
    # 단위:
    #   - ATP, E_buf: [0,100] (정규화, 0~100 범위) ⭐ V3 계약 고정
    #   - P_in, P_loss, J_use: [arb/ms] ⭐ V3: ms 단위 명시
    #   - Heat, CO₂: [arb] (누적량)
    #   - t: [ms] (밀리초) ⭐ V3 계약 고정
    # -----------------------------------------------------------------
    "MITO": {
        "ATP0": 100.0,          # 초기 ATP 농도 [0,100] ⭐ V3: 0~100 범위 명시
        "Ebuf0": 80.0,           # 초기 에너지 버퍼 [arb]
        "Pin": 10.0,             # 에너지 유입량 [arb/ms] (Glucose + O₂ 기반) ⭐ V3: ms 단위 명시
        "Ploss": 1.5,            # 에너지 손실량 [arb/ms] (기본 대사 유지비) ⭐ V3: ms 단위 명시
        "recover_k": 8.0,        # ATP 회복 계수 [arb/ms] (저ATP일 때 회복 속도) ⭐ V3: ms 단위 명시
        "recover_thresh": 60.0,  # 회복 시작 임계값 [0,100] ⭐ V3: 0~100 범위 명시
        "delta_transfer": 5.0,   # ATP 전환 최소 차이 [arb] (E_buf-ATP > 이 값일 때만 전환)
        "ATP_clip": (1.0, 110.0),  # ATP 클램프 범위 [0,100] (물리적 이유: 생리학적 범위 유지) ⭐ V3: 물리적 이유 주석 추가
        "Ebuf_clip": (15.0, 100.0), # E_buf 클램프 범위 [arb] (물리적 이유: 에너지 버퍼 안정성)
        "k_transfer": 0.4,       # E_buf→ATP 전환 계수 [1/ms] ⭐ V3: ms 단위 명시
        "eta": 0.60,             # 전환 효율 (0~1, 0.6 = 60% 효율, 40%는 Heat로 손실)
        "c_CO2": 0.80,           # CO₂ 생성 비율 (ATP당 CO₂ 양)
        "Heat0": 0.0,            # 초기 누적 발열 [arb]
        "CO2_0": 0.0,            # 초기 누적 CO₂ [arb]
    },

    # -----------------------------------------------------------------
    # [Hodgkin–Huxley Soma — Membrane]
    # -----------------------------------------------------------------
    # Hodgkin-Huxley 모델: 막전위 동역학 및 액션 전위 생성
    #
    # 수식:
    #   C_m dV/dt = g_Na m³h (E_Na - V) + g_K n⁴ (E_K - V) + g_L (E_L - V)
    #                + I_ext - I_pump(ATP)
    #   dm/dt = α_m(V)(1-m) - β_m(V)m  (h, n 유사식)
    #
    # 단위:
    #   - V, E_Na, E_K, E_L: [mV] (밀리볼트)
    #   - I_ext, I_pump: [µA/cm²] (마이크로암페어/제곱센티미터)
    #   - g_Na, g_K, g_L: [mS/cm²] (밀리지멘스/제곱센티미터)
    #   - C_m: [µF/cm²] (마이크로패럿/제곱센티미터)
    #   - t: [ms] (밀리초) ⭐ V3 계약 고정
    #   - ATP: [0,100] (정규화, 0~100 범위) ⭐ V3 계약 고정
    # -----------------------------------------------------------------
    "HH": {
        "V0": -70.0,            # 초기 막전위 [mV]
        "gNa": 120.0,           # Na⁺ 채널 전도도 [mS/cm²]
        "gK": 36.0,             # K⁺ 채널 전도도 [mS/cm²]
        "gL": 0.3,              # 누출 채널 전도도 [mS/cm²]
        "ENa": 50.0,            # Na⁺ 역전위 [mV]
        "EK": -77.0,            # K⁺ 역전위 [mV]
        "EL": -54.4,            # 누출 역전위 [mV]
        "C_m": 1.0,             # 막 용량 [µF/cm²]
        "g_pump": 0.05,         # Na/K 펌프 전도도 [mS/cm²]
        "ATP0_ref": 100.0,      # 기준 ATP 농도 [0,100] ⭐ V3: 0~100 범위 명시
    },

    # -----------------------------------------------------------------
    # [Myelinated Axon — Saltatory Conduction]
    # -----------------------------------------------------------------
    # 수초화 축삭: 도약전도 모델
    #
    # 수식:
    #   ∂V/∂t = D(x)·∂²V/∂x² - (V - V_rest)/τ + I_ext/C_m
    #
    # 단위:
    #   - V: [mV] (밀리볼트)
    #   - D: [cm²/ms] (제곱센티미터/밀리초) ⭐ V3: ms 단위 명시
    #   - x: [cm] (센티미터)
    #   - t: [ms] (밀리초) ⭐ V3 계약 고정
    #   - ATP: [0,100] (정규화, 0~100 범위) ⭐ V3 계약 고정
    # -----------------------------------------------------------------
    "AXON": {
        "N": 50,                # 노드 수 (정수)
        "dx": 0.01,             # 노드 간격 [cm]
        "D_node": 0.5,          # 노드 확산 계수 [cm²/ms] ⭐ V3: ms 단위 명시
        "D_internode": 0.05,   # 인터노드 확산 계수 [cm²/ms] ⭐ V3: ms 단위 명시
        "Vrest": -70.0,         # 휴지 전위 [mV]
        "tau": 5.0,             # 시간 상수 [ms] ⭐ V3: ms 단위 명시
        "stim_gain": 15.0,      # 소마→0번노드 주입 이득 (사용 시)
        "coupling": 0.0,        # 소마-축삭 직접결합 계수 (0 = 초기 전도 확인 모드)
        "c0": 1.0,              # 초기 확산 스케일
        "Lambda": 0.0,          # 시간 감쇠 계수 [1/ms] ⭐ V3: ms 단위 명시
        "gamma_decay": 0.0,     # 추가 감쇠 계수 [1/ms] ⭐ V3: ms 단위 명시
    },

    # -----------------------------------------------------------------
    # [Ca²⁺ Vesicle — Synaptic Release]
    # -----------------------------------------------------------------
    # Ca²⁺ 소포: 시냅스 전달물질 방출을 위한 Ca²⁺ 농도 모델링
    #
    # 수식:
    #   d[Ca]/dt = Σ_k A·α(t - t_k) - k_c·ATP·([Ca] - [Ca]_0)
    #   α(t) = (e^{-t/τ_d} - e^{-t/τ_r})_+   (스파이크 트리거 커널)
    #   S = ([Ca]-[Ca]_0)/([Ca]_max-[Ca]_0) ∈ [0,1]  (포화도)
    #
    # 의미:
    #   - 스파이크 발생 시 Ca²⁺ 유입 (α 커널)
    #   - ATP 의존적 Ca²⁺ 펌프로 Ca²⁺ 제거
    #   - S: 포화도 (0~1, under/normal/alert 상태 판단)
    #
    # 단위:
    #   - [Ca]: [μM] (마이크로몰) ⭐ V3 계약 고정
    #   - S: [0,1] (정규화된 Ca 농도) ⭐ V3 계약 고정
    #   - t: [ms] (밀리초) ⭐ V3 계약 고정
    #   - tau_r, tau_d: [s] (초, 내부적으로 ms로 변환)
    #   - ATP: [0,100] (정규화, 0~100 범위) ⭐ V3 계약 고정
    # -----------------------------------------------------------------
    "CA": {
        "C0": 0.1,              # 기준 Ca²⁺ 농도 [μM] ⭐ V3: μM 단위 명시
        "Cmax": 5.0,            # 최대 Ca²⁺ 농도 [μM] ⭐ V3: μM 단위 명시
        "A": 0.25,              # α 커널 스케일 [μM/s] per spike ⭐ V3: μM 단위 명시
        "tau_r": 0.01,          # α 커널 상승 시간 [s] (빠른 유입)
        "tau_d": 0.20,          # α 커널 감쇠 시간 [s] (느린 감쇠)
        "k_c": 0.20,            # Ca²⁺ 펌프 계수 [1/s] (ATP 의존적)
        "max_spike_memory_ms": 2000.0,  # 스파이크 메모리 최대 시간 [ms] ⭐ V3: ms 단위 명시
        "dt_ms": 1.0,           # Ca²⁺ 업데이트 시간 스텝 [ms] ⭐ V3: ms 단위 명시
    },

    # -----------------------------------------------------------------
    # [Integrator / Run]
    # -----------------------------------------------------------------
    # 시뮬레이터 상위 시간해상도와 출력 주기 설정
    #
    # CFL 조건:
    #   dt_elec <= 0.9 * dx² / (2 * max(D_node, D_internode))
    #   위 조건을 만족해야 수치 안정성 보장
    #
    # 시간 스케일:
    #   - dt_elec: 전기적 시간 스텝 [ms] (HH, Axon 등 빠른 동역학) ⭐ V3: ms 단위 명시
    #   - dt_bio: 생리학적 시간 스텝 [ms] (Mito, DTG 등 느린 동역학) ⭐ V3: ms 단위 명시
    #   - dt_bio ≫ dt_elec (일반적으로 100배 이상)
    # -----------------------------------------------------------------
    "RUN": {
        "T_ms": 300,            # 총 시뮬레이션 시간 [ms] ⭐ V3: ms 단위 명시
        "dt_bio": 1.0,          # 생리학적 시간 스텝 [ms] (Mito, DTG 등) ⭐ V3: ms 단위 명시
        "dt_elec": 0.01,        # 전기적 시간 스텝 [ms] (HH, Axon 등) ⭐ V3: ms 단위 명시
        "print_every_ms": 2,    # 출력 주기 [ms] (상태 출력 간격) ⭐ V3: ms 단위 명시
        "color": True,          # 컬러 출력 사용 여부 (터미널 출력)
    },

    # -----------------------------------------------------------------
    # [Alpha Pulse] — 스파이크 시 α-자극(선택)
    # -----------------------------------------------------------------
    # 스파이크 발생 시 추가 전류 펄스 주입
    #
    # 수식:
    #   I_alpha(t) = I0 · (e^{-t/τ_d} - e^{-t/τ_r})_+
    #
    # 단위:
    #   - I0: [μA/cm²] (펄스 최대 진폭)
    #   - tau_r, tau_d: [ms] (상승/감쇠 시간 상수) ⭐ V3: ms 단위 명시
    #   - t: [ms] (밀리초) ⭐ V3 계약 고정
    # -----------------------------------------------------------------
    "ALPHA": {
        "I0": 50.0,             # 펄스 최대 진폭 [μA/cm²]
        "tau_r": 0.5,           # 상승 시간 상수 [ms] (빠른 상승) ⭐ V3: ms 단위 명시
        "tau_d": 3.0,           # 감쇠 시간 상수 [ms] (느린 감쇠) ⭐ V3: ms 단위 명시
    },

    # -----------------------------------------------------------------
    # [Energy Ledger] — 에너지/비용 회계(선택)
    # -----------------------------------------------------------------
    # 에너지 생산/소비 추적 및 회계
    #
    # 파라미터:
    #   - xi_prod: 외생적 생산률 [arb/ms] (외부에서 공급되는 에너지) ⭐ V3: ms 단위 명시
    #   - chi_spike: 스파이크 비용 [arb] (스파이크당 소비되는 에너지)
    #   - zeta_leak: 누설 비용 계수 [arb/ms] (전위 편차에 따른 누설 비용) ⭐ V3: ms 단위 명시
    #
    # 사용법:
    #   - 모든 값이 0.0이면 비활성 (에너지 회계 없음)
    #   - 양수 값으로 설정 시 에너지 생산/소비 추적 활성화
    # -----------------------------------------------------------------
    "LEDGER": {
        "xi_prod": 0.0,         # 외생적 생산률 [arb/ms] ⭐ V3: ms 단위 명시
        "chi_spike": 0.0,       # 스파이크 비용 [arb] (스파이크당 소비되는 에너지)
        "zeta_leak": 0.0,       # 누설 비용 계수 [arb/ms] ⭐ V3: ms 단위 명시
    },

    # -----------------------------------------------------------------
    # [Metabolic Feedback] — Heat/CO₂/Ca 기반 대사 피드백(선택)
    # -----------------------------------------------------------------
    # 대사 부산물(Heat, CO₂, Ca²⁺)에 따른 동적 피드백 조정
    #
    # 수식:
    #   η(t+) = η0 - β_heat·Heat    (효율 감소: Heat 증가 시)
    #   P_loss(t+) = P_loss0·(1 + β_CO₂·CO₂)  (손실 증가: CO₂ 증가 시)
    #   recover_k(alert) = recover_k0 · (1 + λ_ca)  (Ca²⁺ 높을 때 회복 강화)
    #   recover_k(under) = recover_k0 · (1 - λ_under)  (Ca²⁺ 낮을 때 회복 약화)
    #
    # 단위:
    #   - Heat, CO₂: [arb] (누적량)
    #   - β_heat, β_CO₂: [1/arb] (피드백 계수)
    #   - λ_ca, λ_under: [무차원] (가중치)
    # -----------------------------------------------------------------
    "FEEDBACK": {
        "beta_heat": 0.0015,    # Heat 피드백 계수 [1/arb] (Heat 1단위당 효율 감소)
        "beta_co2": 0.0010,     # CO₂ 피드백 계수 [1/arb] (CO₂ 1단위당 손실 증가)
        "lambda_ca": 0.3,       # Ca²⁺ alert 상태 회복 강화 계수 (0.3 = 30% 증가)
        "lambda_under": 0.1,    # Ca²⁺ under 상태 회복 약화 계수 (0.1 = 10% 감소)
    },

    # -----------------------------------------------------------------
    # [Synaptic Resonance] — 위상–Ca 공명(선택)
    # -----------------------------------------------------------------
    # 시냅스 위상과 DTG 위상 간의 공명 모델링
    #
    # 수식:
    #   θ̇ = ω + K·sin(φ - θ)·(1 + λ·S)
    #
    # 의미:
    #   - θ: 시냅스 위상 [rad]
    #   - φ: DTG 위상 [rad]
    #   - S: Ca²⁺ 포화도 (0~1) ⭐ V3 계약 고정
    #   - K: 위상 결합 강도 (DTG와 시냅스 위상 동기화)
    #   - λ: Ca²⁺ 증폭 계수 (Ca²⁺ 높을수록 결합 강화)
    #
    # 단위:
    #   - ω, θ̇: [rad/ms] (위상 속도) ⭐ V3: ms 단위 명시
    #   - K, λ: [무차원]
    #   - t: [ms] (밀리초) ⭐ V3 계약 고정
    # -----------------------------------------------------------------
    "RESONANCE": {
        "omega": 1.0,           # 기본 위상 속도 [rad/ms] ⭐ V3: ms 단위 명시
        "K": 0.05,              # 위상 결합 강도 (DTG–시냅스 위상 동기화)
        "lambda_ca": 1.0,       # Ca²⁺ 증폭 계수 (Ca²⁺ 높을수록 결합 강화)
    },

    # -----------------------------------------------------------------
    # [Autonomous Firing] — DTG 기반 자기 발화
    # -----------------------------------------------------------------
    # DTG 위상이 직접 입력 전류를 생성하여 자기 발화를 구현
    #
    # 수식:
    #   I_base = I_stim + I_autonomous · (1 + 0.5·cos(φ))
    #   - I_stim: 외부 자극 전류 (선택적)
    #   - I_autonomous: 기본 자율 전류 (DTG 위상 변조됨)
    #   - φ: DTG 위상 [rad] (자체적으로 생성됨)
    #
    # 단위:
    #   - I_autonomous: [µA/cm²] (기본 자율 전류)
    #   - I_stim: [µA/cm²] (외부 자극 전류)
    # -----------------------------------------------------------------
    "AUTONOMOUS": {
        "I_base": 10.0,         # 기본 자율 전류 [µA/cm²] (DTG 위상 변조됨)
                                 # 0으로 설정하면 자기 발화 비활성화
    },
}

# =============================================================
# Helper Functions: 안전 복사 & CFL 체크
# =============================================================

def get_config():
    """
    외부에서 안전하게 CONFIG를 가져가도록 deepcopy 반환.
    
    Returns
    -------
    dict
        CONFIG 딕셔너리의 깊은 복사본 (원본 변경 방지)
        
    사용법:
        cfg = get_config()
        cfg["AXON"]["N"] = 200  # 원본은 변경되지 않음
    """
    return deepcopy(CONFIG)

def cfl_dt_ax(config=None):
    """
    CFL 상한(dt_ax) 계산: Courant-Friedrichs-Lewy 조건
    
    CFL 조건은 수치 안정성을 보장하기 위한 필수 조건입니다.
    dt > dt_cfl이면 수치 불안정성이 발생할 수 있습니다.
    
    Parameters
    ----------
    config : dict, optional
        설정 딕셔너리. 기본값: None (전역 CONFIG 사용)
        
    Returns
    -------
    float
        CFL 상한 시간 스텝 [ms] ⭐ V3: ms 단위 명시
        
    수식:
        dt_cfl = cfl_safety * dx² / (2 * Dmax)
        
    여기서:
        - cfl_safety: 안전 계수 (일반적으로 0.9)
        - dx: 공간 간격 [cm]
        - Dmax: 최대 확산 계수 [cm²/ms] ⭐ V3: ms 단위 명시
    """
    if config is None:
        config = CONFIG
    
    cfl_safety = 0.9
    dx = config["AXON"]["dx"]
    Dmax = max(config["AXON"]["D_node"], config["AXON"]["D_internode"])
    
    dt_cfl = cfl_safety * dx**2 / (2 * Dmax)  # [ms] ⭐ V3: ms 단위 명시
    return dt_cfl

def print_cfl_report(config=None):
    """
    CFL 조건 검증 리포트 출력
    
    Parameters
    ----------
    config : dict, optional
        설정 딕셔너리. 기본값: None (전역 CONFIG 사용)
    """
    if config is None:
        config = CONFIG
    
    dt_elec = config["RUN"]["dt_elec"]
    dt_cfl = cfl_dt_ax(config)
    
    print("=" * 60)
    print("CFL 조건 검증 리포트")
    print("=" * 60)
    print(f"dt_elec (설정값): {dt_elec:.6f} [ms]")
    print(f"dt_cfl (CFL 상한): {dt_cfl:.6f} [ms]")
    print(f"안전 마진: {dt_cfl / dt_elec:.2f}x")
    
    if dt_elec <= dt_cfl:
        print("✅ CFL 조건 만족: 수치 안정성 보장")
    else:
        print("⚠️ CFL 조건 위반: 수치 불안정성 가능")
    print("=" * 60)


# =============================================================
# V3 독립 실행 테스트
# =============================================================
if __name__ == "__main__":
    """
    V3 계약 고정 검증:
    - 시간 단위: [ms] 확인
    - Ca: [μM] 확인
    - S: [0,1] 확인
    - ATP: [0,100] 확인
    """
    print("=" * 60)
    print("V3 계약 고정 검증")
    print("=" * 60)
    
    # ATP 정규화 범위 확인
    print(f"ATP 초기값: {CONFIG['MITO']['ATP0']} [0,100] ✅")
    print(f"ATP 클램프: {CONFIG['MITO']['ATP_clip']} [0,100] ✅")
    
    # 시간 단위 확인
    print(f"dt_bio: {CONFIG['RUN']['dt_bio']} [ms] ✅")
    print(f"dt_elec: {CONFIG['RUN']['dt_elec']} [ms] ✅")
    
    # Ca 단위 확인
    print(f"Ca C0: {CONFIG['CA']['C0']} [μM] ✅")
    print(f"Ca Cmax: {CONFIG['CA']['Cmax']} [μM] ✅")
    
    # CFL 조건 검증
    print_cfl_report()
    
    print("\n✅ V3 계약 고정 검증 완료")

