# =============================================================
# 08.metabolic_feedback.py â€” HeatÂ·COâ‚‚Â·Ca ê¸°ë°˜ ëŒ€ì‚¬ í”¼ë“œë°± ë£¨í”„ (V3)
# =============================================================
# ëª©ì :
#   â€¢ ë¯¸í† ì½˜ë“œë¦¬ì•„(Mitochondria)ì˜ ì—ë„ˆì§€ íš¨ìœ¨(Î·),
#     ì†ì‹¤ìœ¨(P_loss), íšŒë³µë¥ (recover_k)ì„
#     ë°œì—´(Heat), ì´ì‚°í™”íƒ„ì†Œ(COâ‚‚), ì¹¼ìŠ˜(CaÂ²âº) ìƒíƒœì— ë”°ë¼
#     ë™ì ìœ¼ë¡œ ë³´ì •í•˜ëŠ” ìƒë¦¬í•™ì  í”¼ë“œë°± ë£¨í”„ë¥¼ êµ¬í˜„í•œë‹¤.
#
# V3 ê³„ì•½ ê³ ì •:
#   - Heat, COâ‚‚: [arb] (ëˆ„ì ëŸ‰)
#   - Î·: [0,1] (íš¨ìœ¨, ë¬´ì°¨ì›)
#   - P_loss: [arb/ms] (ì†ì‹¤ìœ¨) â­ V3: ms ë‹¨ìœ„ ëª…ì‹œ
#   - recover_k: [arb/ms] (íšŒë³µë¥ ) â­ V3: ms ë‹¨ìœ„ ëª…ì‹œ
#   - ca_status: "under" | "normal" | "alert"
#
# ì—°ë™:
#   - ì…ë ¥:  Mito (Heat, COâ‚‚), CaVesicle.status("under"/"normal"/"alert")
#   - ì¶œë ¥:  Mito ë‚´ë¶€ ë³€ìˆ˜ (Î·, P_loss, recover_k)
#
# ìƒë¦¬í•™ì  ê·¼ê±°:
#   Heat â†‘  â†’ ë¯¸í† ì½˜ë“œë¦¬ì•„ íš¨ìœ¨(Î·) â†“
#   COâ‚‚ â†‘   â†’ ì—ë„ˆì§€ ì†ì‹¤ë¥ (P_loss) â†‘
#   Ca alert â†’ ATP íšŒë³µë¥ (recover_k) â†‘
#   Ca under â†’ ATP íšŒë³µë¥ (recover_k) â†“
#
# ì„¤ê³„ ì´ìœ :
#   - ëŒ€ì‚¬ í”¼ë“œë°±ì€ ë‰´ëŸ°ì˜ í•­ìƒì„± ìœ ì§€ ë©”ì»¤ë‹ˆì¦˜
#   - Heatì™€ COâ‚‚ëŠ” ëŒ€ì‚¬ ë¶€ì‚°ë¬¼ë¡œ, íš¨ìœ¨ê³¼ ì†ì‹¤ì— ì˜í–¥ì„ ë¯¸ì¹¨
#   - CaÂ²âº ìƒíƒœëŠ” ë‰´ëŸ° í™œë™ ìˆ˜ì¤€ì„ ë°˜ì˜í•˜ì—¬ íšŒë³µë¥  ì¡°ì •
# =============================================================

import numpy as np


class MetabolicFeedback:
    r"""
    MetabolicFeedback â€” Energy Homeostasis Feedback Controller (V3)
    ------------------------------------------------------------
    
    V3 ê³„ì•½:
    - ì…ë ¥: ca_status ("under" | "normal" | "alert")
    - ì¶œë ¥: ì—†ìŒ (Mito ë‚´ë¶€ ë³€ìˆ˜ ìˆ˜ì •)
    - Side-effect:
      - self.mito.eta0 ì—…ë°ì´íŠ¸ [0,1]
      - self.mito.Ploss ì—…ë°ì´íŠ¸ [arb/ms] â­ V3: ms ë‹¨ìœ„ ëª…ì‹œ
      - self.mito.recover_k ì—…ë°ì´íŠ¸ [arb/ms] â­ V3: ms ë‹¨ìœ„ ëª…ì‹œ
    
    âš™ï¸ ì—­í• :
        ë¯¸í† ì½˜ë“œë¦¬ì•„ì˜ ëŒ€ì‚¬ íš¨ìœ¨(Î·), ì†ì‹¤ë¥ (P_loss),
        íšŒë³µë¥ (recover_k)ì„ HeatÂ·COâ‚‚Â·Ca ìƒíƒœì— ë”°ë¼ ê°±ì‹ í•œë‹¤.

    ------------------------------------------------------------
    ğŸ“˜ ì—°ë™ ê³„ì¸µ:
        - ì…ë ¥:  Mitochondria (Heat, COâ‚‚), CaVesicle.status
        - ì¶œë ¥:  Mito ë‚´ë¶€ ë³€ìˆ˜ ìˆ˜ì • (Î·, P_loss, recover_k)

    ------------------------------------------------------------
    ğŸ“ ìˆ˜ì‹ ìš”ì•½:
        (1) ë°œì—´(Heat) â†’ íš¨ìœ¨ ì €í•˜
            Î·(t+Î”t) = Î·â‚€ âˆ’ Î²_heat Â· (Heat âˆ’ Heatâ‚€)
            Î· âˆˆ [0.05, Î·â‚€]

        (2) ì´ì‚°í™”íƒ„ì†Œ(COâ‚‚) â†’ ì†ì‹¤ìœ¨ ì¦ê°€
            P_loss(t+Î”t) = P_lossâ‚€ Â· (1 + Î²_COâ‚‚ Â· COâ‚‚)

        (3) ì¹¼ìŠ˜(CaÂ²âº) ìƒíƒœ â†’ íšŒë³µë¥  ì¡°ì •
            recover_k(t+Î”t) =
                â”Œ kâ‚€ Â· (1 + Î»_Ca)       , if Ca_status = "alert"
                â”œ kâ‚€ Â· (1 âˆ’ Î»_under)    , if Ca_status = "under"
                â”” kâ‚€                    , otherwise
    
    ì„¤ê³„ ì´ìœ :
    - ëŒ€ì‚¬ í”¼ë“œë°±ì€ ë‰´ëŸ°ì˜ í•­ìƒì„± ìœ ì§€ ë©”ì»¤ë‹ˆì¦˜
    - Heatì™€ COâ‚‚ëŠ” ëŒ€ì‚¬ ë¶€ì‚°ë¬¼ë¡œ, íš¨ìœ¨ê³¼ ì†ì‹¤ì— ì˜í–¥ì„ ë¯¸ì¹¨
    - CaÂ²âº ìƒíƒœëŠ” ë‰´ëŸ° í™œë™ ìˆ˜ì¤€ì„ ë°˜ì˜í•˜ì—¬ íšŒë³µë¥  ì¡°ì •
    ------------------------------------------------------------
    """

    def __init__(self, mito, cfg=None):
        """
        MetabolicFeedback ì´ˆê¸°í™”
        
        Parameters
        ----------
        mito : object
            Mitochondria ì¸ìŠ¤í„´ìŠ¤. (í•„ìˆ˜)
            ë‹¤ìŒ ì†ì„±ì„ ê°€ì ¸ì•¼ í•¨:
                â€¢ mito.Heat [arb] (ëˆ„ì  ë°œì—´)
                â€¢ mito.CO2 [arb] (ëˆ„ì  COâ‚‚)
                â€¢ mito.eta0 [0,1] (ê¸°ë³¸ íš¨ìœ¨)
                â€¢ mito.Ploss [arb/ms] (ì†ì‹¤ìœ¨) â­ V3: ms ë‹¨ìœ„ ëª…ì‹œ
                â€¢ mito.recover_k [arb/ms] (íšŒë³µë¥ ) â­ V3: ms ë‹¨ìœ„ ëª…ì‹œ
        cfg : dict, optional
            í”¼ë“œë°± ê³„ìˆ˜ ì„¤ì •ê°’. ê¸°ë³¸ê°’:
                Î²_heat   = 0.0015   # Heat â†’ Î· ê°ì†Œ ê³„ìˆ˜ [1/arb]
                Î²_COâ‚‚    = 0.0010   # COâ‚‚ â†’ P_loss ì¦ê°€ ê³„ìˆ˜ [1/arb]
                Î»_Ca     = 0.3      # Ca alert ì‹œ íšŒë³µ ê°•í™” ë¹„ìœ¨ (ë¬´ì°¨ì›)
                Î»_under  = 0.1      # Ca under ì‹œ íšŒë³µ ì–µì œ ë¹„ìœ¨ (ë¬´ì°¨ì›)
        """
        self.mito = mito
        self.cfg = cfg or {
            "beta_heat": 0.0015,  # [1/arb] (Heat 1ë‹¨ìœ„ë‹¹ íš¨ìœ¨ ê°ì†Œ)
            "beta_co2": 0.0010,  # [1/arb] (COâ‚‚ 1ë‹¨ìœ„ë‹¹ ì†ì‹¤ ì¦ê°€)
            "lambda_ca": 0.3,    # [ë¬´ì°¨ì›] (Ca alert ì‹œ íšŒë³µ ê°•í™” ë¹„ìœ¨)
            "lambda_under": 0.1, # [ë¬´ì°¨ì›] (Ca under ì‹œ íšŒë³µ ì–µì œ ë¹„ìœ¨)
        }

        # --- ê¸°ì¤€ê°’ ì €ì¥ ---
        #   ì´ˆê¸° ê¸°ì¤€ íš¨ìœ¨(Î·â‚€), ì†ì‹¤ìœ¨(P_lossâ‚€), íšŒë³µë¥ (kâ‚€)
        #   âš ï¸ ì„¤ê³„ ì„ íƒ: eta_baseëŠ” "ì†ìƒ ì „ ì´ˆê¸°ê°’" (ë³µêµ¬ ë¶ˆê°€ëŠ¥í•œ ì†ìƒ ëª¨ë¸)
        #      - eta0ëŠ” ì—´ ìŠ¤íŠ¸ë ˆìŠ¤ë¡œ ì†ìƒë  ìˆ˜ ìˆìŒ (ì¥ê¸° í”¼ë¡œ ëˆ„ì )
        #      - í•­ìƒì„± ì»¨íŠ¸ë¡¤ëŸ¬ì´ì§€ë§Œ, ê¸°ì¤€ê°’ ìì²´ê°€ ì†ìƒë˜ëŠ” ëª¨ë¸
        #      - (ì ì‘í˜• ë¯¸í† ì½˜ë“œë¦¬ì•„ê°€ ì•„ë‹˜ - V2ì—ì„œ í™•ì¥ ê°€ëŠ¥)
        self.eta_base = getattr(mito, "eta0", 0.60)  # [0,1]
        self.Ploss_base = getattr(mito, "Ploss", 1.5)  # [arb/ms] â­ V3: ms ë‹¨ìœ„ ëª…ì‹œ
        self.recover_base = getattr(mito, "recover_k", 8.0)  # [arb/ms] â­ V3: ms ë‹¨ìœ„ ëª…ì‹œ

    # =========================================================
    # ë©”ì¸ í”¼ë“œë°± ì—…ë°ì´íŠ¸
    # =========================================================
    def update(self, ca_status: str):
        """
        HeatÂ·COâ‚‚Â·Ca ìƒíƒœì— ë”°ë¼ Mitochondria ë‚´ë¶€ ë³€ìˆ˜ ë³´ì •.
        
        V3 ê³„ì•½:
        - ì…ë ¥: ca_status ("under" | "normal" | "alert")
        - ì¶œë ¥: ì—†ìŒ
        - Side-effect:
          - self.mito.eta0 ì—…ë°ì´íŠ¸ [0,1]
          - self.mito.Ploss ì—…ë°ì´íŠ¸ [arb/ms] â­ V3: ms ë‹¨ìœ„ ëª…ì‹œ
          - self.mito.recover_k ì—…ë°ì´íŠ¸ [arb/ms] â­ V3: ms ë‹¨ìœ„ ëª…ì‹œ

        Parameters
        ----------
        ca_status : str
            "alert" | "normal" | "under"
            CaVesicle.get_state()["status"] ê°’ ì‚¬ìš©.
        """

        # -----------------------------------------------------
        # (1) Heat â†‘ â†’ íš¨ìœ¨ Î· â†“
        # Î·(t+Î”t) = Î·â‚€ âˆ’ Î²_heat Â· Heat
        # 
        # âš ï¸ ì„¤ê³„ ì„ íƒ: HeatëŠ” "ëˆ„ì  ì—´ë¶€í•˜(thermal debt)"ë¡œ í•´ì„
        #   - HeatëŠ” ì ˆëŒ€ëŸ‰ (ê¸°ì¤€ì  Heatâ‚€ ì—†ìŒ)
        #   - ì—´ì´ ìŒ“ì¼ìˆ˜ë¡ íš¨ìœ¨ì´ ê³„ì† ê°ì†Œ (ì—´ ìŠ¤íŠ¸ë ˆìŠ¤ ë°˜ì˜ ëª¨ë¸)
        #   - ì—´ ë°©ì¶œ(ì¿¨ë§)ì€ Mito ë‚´ë¶€ì—ì„œ ë³„ë„ ì²˜ë¦¬
        # 
        # âš ï¸ ì¤‘ìš”: eta0 ìì²´ë¥¼ ìˆ˜ì • (ì¥ê¸° ì†ìƒ ëª¨ë¸)
        #   - eta0ëŠ” "ì†ìƒ ê°€ëŠ¥í•œ ê¸°ì¤€ê°’" (ë³µêµ¬ ë¶ˆê°€ëŠ¥í•œ ì†ìƒ)
        #   - ì¥ê¸° í”¼ë¡œ/ë²ˆì•„ì›ƒ ëª¨ë¸ë¡œ í™•ì¥ ê°€ëŠ¥
        #   - Mitochondria.step()ì—ì„œ eta0ë¥¼ ê¸°ì¤€ìœ¼ë¡œ eta_dynamic() ê³„ì‚°
        # -----------------------------------------------------
        delta_eta = - self.cfg["beta_heat"] * max(0.0, self.mito.Heat)  # [ë¬´ì°¨ì›] = [1/arb] Â· [arb]
        new_eta0 = self.eta_base + delta_eta  # [0,1]
        # ë¬¼ë¦¬ì  ì´ìœ : eta0ëŠ” ë¬¼ë¦¬ì  í•˜í•œ 0.05 ì´í•˜ë¡œ ë–¨ì–´ì§€ì§€ ì•ŠìŒ (ìƒë¦¬í•™ì  ì œì•½)
        self.mito.eta0 = float(np.clip(new_eta0, 0.05, 1.0))  # [0,1]

        # -----------------------------------------------------
        # (2) COâ‚‚ â†‘ â†’ ì†ì‹¤ë¥  P_loss â†‘
        # P_loss(t+Î”t) = P_lossâ‚€ Â· (1 + Î²_COâ‚‚ Â· COâ‚‚)
        # -----------------------------------------------------
        new_Ploss = self.Ploss_base * (1.0 + self.cfg["beta_co2"] * max(0.0, self.mito.CO2))  # [arb/ms] â­ V3: ms ë‹¨ìœ„ ëª…ì‹œ
        # ë¬¼ë¦¬ì  ì´ìœ : P_lossëŠ” ìŒìˆ˜ê°€ ë  ìˆ˜ ì—†ìœ¼ë©°, ìƒí•œì„ ìœ¼ë¡œ ìˆ˜ì¹˜ ì•ˆì •ì„± ë³´ì¥
        self.mito.Ploss = float(np.clip(new_Ploss, 0.0, 100.0))  # [arb/ms] â­ V3: ms ë‹¨ìœ„ ëª…ì‹œ

        # -----------------------------------------------------
        # (3) Ca ìƒíƒœ â†’ íšŒë³µë¥  recover_k ì¡°ì •
        # -----------------------------------------------------
        if ca_status == "alert":
            # ğŸ”º ê³¼í™œì„± ìƒíƒœ: ATP íšŒë³µë¥  ê°•í™”
            # ë¬¼ë¦¬ì  ì´ìœ : CaÂ²âºê°€ ë†’ìœ¼ë©´ ë‰´ëŸ°ì´ ê³¼í™œì„± ìƒíƒœì´ë¯€ë¡œ ATP íšŒë³µ ê°•í™” í•„ìš”
            new_recover = self.recover_base * (1.0 + self.cfg["lambda_ca"])  # [arb/ms] â­ V3: ms ë‹¨ìœ„ ëª…ì‹œ
        elif ca_status == "under":
            # ğŸ”» ë¹„í™œì„± ìƒíƒœ: íšŒë³µ ì–µì œ
            # ë¬¼ë¦¬ì  ì´ìœ : CaÂ²âºê°€ ë‚®ìœ¼ë©´ ë‰´ëŸ°ì´ ë¹„í™œì„± ìƒíƒœì´ë¯€ë¡œ íšŒë³µ ì–µì œ
            new_recover = self.recover_base * (1.0 - self.cfg["lambda_under"])  # [arb/ms] â­ V3: ms ë‹¨ìœ„ ëª…ì‹œ
        else:
            # ğŸŸ¢ ì •ìƒ ìƒíƒœ: ê¸°ë³¸ê°’ ìœ ì§€
            new_recover = self.recover_base  # [arb/ms] â­ V3: ms ë‹¨ìœ„ ëª…ì‹œ

        # ë¬¼ë¦¬ì  ì´ìœ : recover_këŠ” ìŒìˆ˜ê°€ ë  ìˆ˜ ì—†ìœ¼ë©°, ìƒí•œì„ ìœ¼ë¡œ ìˆ˜ì¹˜ ì•ˆì •ì„± ë³´ì¥
        self.mito.recover_k = float(np.clip(new_recover, 0.0, 50.0))  # [arb/ms] â­ V3: ms ë‹¨ìœ„ ëª…ì‹œ

    # =========================================================
    # ìƒíƒœ ì¶œë ¥ (ë””ë²„ê¹… ë° ë¡œê¹…ìš©)
    # =========================================================
    def summary(self) -> dict:
        """
        í˜„ì¬ í”¼ë“œë°± ì¡°ì • í›„ì˜ Mitochondria ì£¼ìš” ë³€ìˆ˜ ë°˜í™˜.
        
        V3 ê³„ì•½:
        - ì…ë ¥: ì—†ìŒ
        - ì¶œë ¥: dict {"eta0": [0,1], "Ploss": [arb/ms], "recover_k": [arb/ms], ...}
        - Side-effect: ì—†ìŒ
        
        Returns
        -------
        dict
            í˜„ì¬ í”¼ë“œë°± ì¡°ì • í›„ì˜ Mitochondria ì£¼ìš” ë³€ìˆ˜
        """
        return {
            "eta0": round(self.mito.eta0, 5),  # [0,1] (ìˆ˜ì •ëœ ê¸°ë³¸ íš¨ìœ¨)
            "Ploss": round(self.mito.Ploss, 5),  # [arb/ms] â­ V3: ms ë‹¨ìœ„ ëª…ì‹œ
            "recover_k": round(self.mito.recover_k, 5),  # [arb/ms] â­ V3: ms ë‹¨ìœ„ ëª…ì‹œ
            "Heat": round(self.mito.Heat, 5),  # [arb]
            "CO2": round(self.mito.CO2, 5),  # [arb]
        }


# =============================================================
# V3 ë…ë¦½ ì‹¤í–‰ í…ŒìŠ¤íŠ¸
# =============================================================
if __name__ == "__main__":
    """
    V3 ê³„ì•½ ê³ ì • ê²€ì¦:
    - ì…ì¶œë ¥/side-effect í™•ì¸
    - ë‹¨ìœ„ ëª…ì‹œ í™•ì¸
    """
    # ë”ë¯¸ Mito í´ë˜ìŠ¤ ìƒì„±
    class DummyMito:
        def __init__(self):
            self.eta0 = 0.6  # [0,1]
            self.Heat = 100.0  # [arb]
            self.CO2 = 50.0  # [arb]
            self.eta = 0.6  # [0,1]
            self.Ploss = 1.5  # [arb/ms] â­ V3: ms ë‹¨ìœ„ ëª…ì‹œ
            self.recover_k = 8.0  # [arb/ms] â­ V3: ms ë‹¨ìœ„ ëª…ì‹œ

    mito = DummyMito()
    fb = MetabolicFeedback(mito)
    
    print("=" * 60)
    print("MetabolicFeedback V3 â€” ê³„ì•½ ê³ ì • ê²€ì¦")
    print("=" * 60)
    print(f"ì´ˆê¸° ìƒíƒœ: {fb.summary()}")
    print("-" * 60)
    
    # í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤
    for status in ["under", "normal", "alert"]:
        fb.update(status)
        print(f"\n[Ca ìƒíƒœ: {status}]")
        print(fb.summary())
    
    print("=" * 60)
    print("âœ… V3 ê³„ì•½ ê³ ì • ê²€ì¦ ì™„ë£Œ")
    print("  - ì…ì¶œë ¥/side-effect ëª…ì‹œ í™•ì¸")
    print("  - ë‹¨ìœ„ ëª…ì‹œ í™•ì¸ ([arb/ms])")

